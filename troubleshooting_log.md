# Протокол Устранения Неполадок и Доработок

Этот документ описывает шаги, предпринятые для диагностики, устранения проблем и последующей доработки приложения Spam Guard.

## Часть 1: Первоначальная Настройка и Обучение (25.07.2025)

...

## Часть 2: Улучшения Веб-интерфейса и Отказоустойчивость (26.07.2025)

...

### 2.3. Реализация сбора и отображения статистики

- **Задача:** Заменить статические данные в разделе статистики на реальные, получаемые из Redis.
- **Решение:**
    1. **Сбор статистики:** Эндпоинт `/classify` был доработан для атомарного инкрементирования счетчиков `stats:total_classified` и `stats:spam_detected` в Redis после каждой классификации.
    2. **Получение статистики:** Эндпоинт `/stats` был переписан для чтения этих счетчиков из Redis. В случае недоступности Redis он возвращает нули.
    3. **Отображение точности:** В `/stats` добавлено чтение последнего показателя `accuracy` из файла `training_results.json`, чтобы в интерфейсе всегда была актуальная информация о качестве модели.
    4. **Обновление интерфейса:** Фронтенд был обновлен для корректного отображения всех новых полей статистики.

### 2.4. Исправление логики получения количества подписчиков

- **Проблема:** Несмотря на предыдущие исправления, приложение по-прежнему для всех статей показывало признак "Low follower count".
- **Расследование:**
    1. **Первоначальная гипотеза:** API `dev.to` не возвращает информацию о подписчиках в общем списке статей. Это подтвердилось.
    2. **Первая попытка исправления:** Был добавлен дополнительный запрос к API `dev.to/api/users/{user_id}` для получения полных данных о пользователе. Однако ошибка сохранилась.
    3. **Вторая попытка и обнаружение бага:** Было выявлено, что данные о подписчиках, полученные в `vectorize_post`, не передавались в `predict` для эвристического анализа, что приводило к неверной оценке.
    4. **Третья попытка и обнаружение коренной причины:** После исправления предыдущего бага ошибка все равно осталась. Финальный анализ показал, что в коде использовалось неверное имя поля для ID пользователя (`user_id` вместо `id`), из-за чего запрос к API пользователей никогда не выполнялся.
- **Решение (финальное):**
    1. В функции `create_features` исправлено имя поля на `post.user.get('id')`.
    2. В `vectorize_post` добавлена логика для корректной обработки ситуации, когда данные о подписчиках получить не удалось (используется значение `-1`).
    3. В `get_spam_indicators` добавлена проверка, чтобы причина "Low follower count" отображалась только в том случае, если данные о подписчиках были успешно загружены и их действительно мало.
    4. Логика передачи данных между `vectorize_post` и `predict` была исправлена, чтобы гарантировать консистентность данных при создании вектора и генерации текстовых причин.
