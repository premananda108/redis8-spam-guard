<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dev.to Spam Classifier</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; display: flex; gap: 40px; }
        .main-content { flex: 2; }
        .sidebar { flex: 1; max-width: 400px; }
        .post { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .spam { background-color: #ffebee; border-color: #f44336; }
        .not-spam { background-color: #e8f5e8; border-color: #4caf50; }
        .uncertain { background-color: #fff3e0; border-color: #ff9800; }
        .reasoning { font-size: 0.9em; color: #666; margin-top: 10px; }
        .controls { margin: 20px 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background-color: #f0f0f0; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        .loading { opacity: 0.6; }
        #page-indicator { font-weight: bold; }
        .manual-check-form { background-color: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .manual-check-form h2 { margin-top: 0; }
        .manual-check-form label { display: block; margin-top: 10px; font-weight: bold; }
        .manual-check-form input, .manual-check-form textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        #log-container { background-color: #222; color: #0f0; font-family: monospace; padding: 15px; height: 400px; overflow-y: scroll; border-radius: 5px; margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="main-content" id="moderation-view">
        <h1>üöÄ Dev.to Post Moderator Assistant</h1>
        <p>AI-powered spam detection using Redis 8 Vector Sets</p>
        
        <div class="controls">
            <button onclick="resetAndLoad()">üîÑ Load Latest Posts</button>
            <button onclick="showStats()">üìä Show Statistics</button>
            <button id="train-button" onclick="showTrainingView()">üöÄ Train Model</button>
        </div>
        
        <div id="stats-container"></div>
        <div id="redis-info-container"></div>
        
        <div id="posts-container"></div>
        
        <div id="pagination-controls" class="controls">
            <button id="prev-button" onclick="prevPage()">‚¨ÖÔ∏è Previous</button>
            <span id="page-indicator">Page 1</span>
            <button id="next-button" onclick="nextPage()">Next ‚û°Ô∏è</button>
        </div>
    </div>

    <div class="main-content" id="training-view" style="display: none;">
        <h1>üéì Model Training Dashboard</h1>
        <p>Review current model statistics before starting a new training cycle.</p>
        
        <div id="current-model-stats" style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <p>Loading current model info...</p>
        </div>

        <div class="controls">
            <button id="start-training-btn" onclick="executeTraining()">üöÄ Start New Training</button>
            <button onclick="switchView('moderation')">‚¨ÖÔ∏è Back to Moderation</button>
        </div>

        <h3>üìú Training Logs</h3>
        <button onclick="refreshLogs()">üîÑ Refresh Logs</button>
        <pre id="log-container">Logs will appear here once training starts.</pre>
    </div>


    <div class="sidebar">
        <div class="manual-check-form">
            <h2>Manual Post Check</h2>
            <p>Enter post details to get an instant diagnosis.</p>
            <label for="manual-title">Title:</label>
            <input type="text" id="manual-title" value="How to earn $1000 in a week!">
            
            <label for="manual-description">Description:</label>
            <textarea id="manual-description" rows="4">Click this link now for a limited time offer. You won't regret it. Best crypto strategy.</textarea>
            
            <label for="manual-tags">Tags (comma-separated):</label>
            <input type="text" id="manual-tags" value="money, crypto, investment, quick">
            
            <label for="manual-reactions">Reactions:</label>
            <input type="number" id="manual-reactions" value="1">
            
            <label for="manual-comments">Comments:</label>
            <input type="number" id="manual-comments" value="0">

            <label for="manual-reading-time">Reading Time (minutes):</label>
            <input type="number" id="manual-reading-time" value="1">

            <label for="manual-followers">Author's Followers:</label>
            <input type="number" id="manual-followers" value="5">
            
            <div class="controls">
                <button id="manual-check-button" onclick="performManualCheck()">üî¨ Check Post</button>
            </div>
            
            <div id="manual-check-result"></div>
        </div>
    </div>
    
    <script>
        let currentPage = 1;
        const postsPerPage = 10;

        function switchView(viewName) {
            const moderationView = document.getElementById('moderation-view');
            const trainingView = document.getElementById('training-view');

            if (viewName === 'training') {
                moderationView.style.display = 'none';
                trainingView.style.display = 'block';
            } else { // moderation
                moderationView.style.display = 'block';
                trainingView.style.display = 'none';
            }
        }

        async function sendFeedback(postId, isSpam, buttonElement) {
            try {
                const response = await fetch('/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        post_id: postId,
                        is_spam: isSpam,
                        moderator_id: "moderator-007"
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to send feedback');
                }
                buttonElement.parentElement.innerHTML = '<strong>‚úÖ Thank you for your feedback!</strong>';
            } catch (error) {
                alert(`Error sending feedback: ${error.message}`);
            }
        }

        async function classifyPost(postData) {
            const response = await fetch('/classify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(postData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Classification failed');
            }
            
            return await response.json();
        }

        async function performManualCheck() {
            const button = document.getElementById('manual-check-button');
            const resultContainer = document.getElementById('manual-check-result');
            
            button.disabled = true;
            button.textContent = 'Checking...';
            resultContainer.innerHTML = '';

            const postData = {
                id: Math.floor(Math.random() * 1000000),
                title: document.getElementById('manual-title').value,
                description: document.getElementById('manual-description').value,
                tag_list: document.getElementById('manual-tags').value.split(',').map(t => t.trim()),
                public_reactions_count: parseInt(document.getElementById('manual-reactions').value) || 0,
                comments_count: parseInt(document.getElementById('manual-comments').value) || 0,
                reading_time_minutes: parseInt(document.getElementById('manual-reading-time').value) || 0,
                user: {
                    id: Math.floor(Math.random() * 100000),
                    followers_count: parseInt(document.getElementById('manual-followers').value) || 0
                }
            };

            try {
                const classification = await classifyPost(postData);
                
                const postElement = document.createElement('div');
                postElement.className = `post ${classification.is_spam ? 'spam' : 
                    (classification.confidence > 0.8 ? 'not-spam' : 'uncertain')}`;
                
                const statusEmoji = classification.is_spam ? 'üö´' : '‚úÖ';
                const recommendationEmoji = {
                    'block': 'üö´',
                    'review': '‚ö†Ô∏è',
                    'approve': '‚úÖ'
                }[classification.recommendation] || '‚ùì';
                
                const similarPostsHtml = classification.similar_posts && classification.similar_posts.length > 0
                    ? `
                    <div class="reasoning">
                        <strong>üîó Similar to posts:</strong>
                        <ul>
                            ${classification.similar_posts.map(p => p.url ? `<li><a href="${p.url}" target="_blank">${p.title}</a> (Score: ${p.score.toFixed(2)})</li>` : `<li>${p.title} (Score: ${p.score.toFixed(2)})</li>`).join('')}
                        </ul>
                    </div>
                    `
                    : '';

                postElement.innerHTML = `
                    <h3>Diagnosis Result</h3>
                    <div>
                        <strong>${statusEmoji} Classification:</strong> ${classification.is_spam ? 'SPAM' : 'LEGITIMATE'}
                        (${(classification.confidence * 100).toFixed(1)}% confidence)
                    </div>
                    <div>
                        <strong>${recommendationEmoji} Recommendation:</strong> ${classification.recommendation.toUpperCase()}
                    </div>
                    <div><strong>‚è±Ô∏è Processing time:</strong> ${classification.processing_time_ms.toFixed(1)}ms</div>
                    ${classification.reasoning.length > 0 ? `
                        <div class="reasoning">
                            <strong>üß† Reasoning:</strong>
                            <ul>${classification.reasoning.map(r => `<li>${r}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                    ${similarPostsHtml}
                `;
                resultContainer.appendChild(postElement);

            } catch (error) {
                resultContainer.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'üî¨ Check Post';
            }
        }
        
        async function loadAndClassifyPosts(page) {
            const container = document.getElementById('posts-container');
            const pageIndicator = document.getElementById('page-indicator');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');

            container.innerHTML = `<p>Loading page ${page}...</p>`;
            pageIndicator.textContent = `Page ${page}`;
            prevButton.disabled = page <= 1;
            
            try {
                const response = await fetch(`https://dev.to/api/articles?state=fresh&per_page=${postsPerPage}&page=${page}`);
                const posts = await response.json();
                
                if (posts.length === 0) {
                    container.innerHTML = '<p>No more posts found.</p>';
                    nextButton.disabled = true;
                    return;
                }
                nextButton.disabled = false;

                container.innerHTML = '';
                
                for (const post of posts) {
                    const postElement = document.createElement('div');
                    postElement.className = 'post loading';
                    postElement.id = `post-${post.id}`;
                    postElement.innerHTML = `
                        <h3><a href="${post.url}" target="_blank">${post.title}</a></h3>
                        <p>${post.description || 'No description'}</p>
                        <div><strong>Tags:</strong> ${post.tag_list.join(', ')}</div>
                        <div><strong>Reading time:</strong> ${post.reading_time_minutes} min</div>
                        <div>üîÑ Classifying...</div>
                    `;
                    container.appendChild(postElement);
                    
                    try {
                        const classification = await classifyPost(post);
                        
                        postElement.className = `post ${classification.is_spam ? 'spam' : 
                            (classification.confidence > 0.8 ? 'not-spam' : 'uncertain')}`;
                        
                        const statusEmoji = classification.is_spam ? 'üö´' : '‚úÖ';
                        const recommendationEmoji = {
                            'block': 'üö´',
                            'review': '‚ö†Ô∏è',
                            'approve': '‚úÖ'
                        }[classification.recommendation] || '‚ùì';
                        
                        const similarPostsHtml = classification.similar_posts && classification.similar_posts.length > 0
                            ? `
                            <div class="reasoning">
                                <strong>üîó Similar to posts:</strong>
                                <ul>
                                    ${classification.similar_posts.map(p => p.url ? `<li><a href="${p.url}" target="_blank">${p.title}</a> (Score: ${p.score.toFixed(2)})</li>` : `<li>${p.title} (Score: ${p.score.toFixed(2)})</li>`).join('')}
                                </ul>
                            </div>
                            `
                            : '';

                        let feedbackHtml = '';
                        if (classification.moderator_verdict) {
                            const verdictText = classification.moderator_verdict === 'spam' ? 'SPAM' : 'LEGITIMATE';
                            feedbackHtml = `<strong style="color: #388e3c;">‚úÖ Reviewed as: ${verdictText}</strong>`;
                        } else {
                            feedbackHtml = `
                                <span>Is this classification wrong?</span>
                                <button onclick="sendFeedback(${post.id}, true, this)">Mark as SPAM</button>
                                <button onclick="sendFeedback(${post.id}, false, this)">Mark as LEGITIMATE</button>
                            `;
                        }

                        postElement.innerHTML = `
                            <h3><a href="${post.url}" target="_blank">${post.title}</a></h3>
                            <p>${post.description || 'No description'}</p>
                            <div><strong>Tags:</strong> ${post.tag_list.join(', ')}</div>
                            <div><strong>Reading time:</strong> ${post.reading_time_minutes} min</div>
                            <div><strong>Reactions:</strong> ${post.public_reactions_count}</div>
                            <hr>
                            <div>
                                <strong>${statusEmoji} Classification:</strong> ${classification.is_spam ? 'SPAM' : 'LEGITIMATE'}
                                (${(classification.confidence * 100).toFixed(1)}% confidence)
                            </div>
                            <div>
                                <strong>${recommendationEmoji} Recommendation:</strong> ${classification.recommendation.toUpperCase()}
                            </div>
                            <div><strong>‚è±Ô∏è Processing time:</strong> ${classification.processing_time_ms.toFixed(1)}ms</div>
                            ${classification.reasoning.length > 0 ? `
                                <div class="reasoning">
                                    <strong>üß† Reasoning:</strong>
                                    <ul>${classification.reasoning.map(r => `<li>${r}</li>`).join('')}</ul>
                                </div>
                            ` : ''}
                            ${similarPostsHtml}
                            <div class="feedback-container" style="margin-top: 10px;">
                                ${feedbackHtml}
                            </div>
                        `;
                    } catch (error) {
                        postElement.innerHTML += `<div style="color: red;">Error: ${error.message}</div>`;
                    }
                }
            } catch (error) {
                container.innerHTML = `<p style="color: red;">Error loading posts: ${error.message}</p>`;
            }
        }

        function nextPage() {
            currentPage++;
            loadAndClassifyPosts(currentPage);
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadAndClassifyPosts(currentPage);
            }
        }

        function resetAndLoad() {
            document.getElementById('stats-container').innerHTML = '';
            switchView('moderation');
            currentPage = 1;
            loadAndClassifyPosts(currentPage);
        }
        
        async function showStats() {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();
                
                const statsContainer = document.getElementById('stats-container');
                const accuracy_text = stats.accuracy ? `${(stats.accuracy * 100).toFixed(2)}%` : 'N/A';

                statsContainer.innerHTML = `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h3>üìä Classification Statistics</h3>
                        <p><strong>Total classified (since last start):</strong> ${stats.total_classified}</p>
                        <p><strong>Spam detected (since last start):</strong> ${stats.spam_detected}</p>
                        <p><strong>Spam rate:</strong> ${(stats.spam_detected / Math.max(stats.total_classified, 1) * 100).toFixed(1)}%</p>
                        <p><strong>Model Accuracy (from training):</strong> ${accuracy_text}</p>
                        <p><strong>Last updated:</strong> ${new Date(stats.last_updated).toLocaleString()}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function showRedisInfo() {
            try {
                const response = await fetch('/redis-info');
                const redisInfo = await response.json();
                
                const redisInfoContainer = document.getElementById('redis-info-container');
                let content = '';
                if (redisInfo.status === 'disconnected') {
                    content = `
                    <div style="background: #fff3e0; padding: 15px; border-radius: 5px; margin: 10px 0; border: 1px solid #ff9800;">
                        <h3>‚ö†Ô∏è Redis Info</h3>
                        <p><strong>Status:</strong> Disconnected</p>
                        <p>Advanced features like vector search are disabled.</p>
                    </div>
                    `;
                } else {
                    content = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0; border: 1px solid #4caf50;">
                        <h3>‚ÑπÔ∏è Redis Info</h3>
                        <p><strong>Redis Version:</strong> ${redisInfo.redis_version}</p>
                        <p><strong>Vectors in DB:</strong> ${redisInfo.num_vectors}</p>
                    </div>
                    `;
                }
                redisInfoContainer.innerHTML = content;
            } catch (error) {
                console.error('Failed to load Redis info:', error);
                const redisInfoContainer = document.getElementById('redis-info-container');
                redisInfoContainer.innerHTML = `<div style="color: red;">Error loading Redis info.</div>`;
            }
        }

        async function showTrainingView() {
            switchView('training');
            const statsContainer = document.getElementById('current-model-stats');
            statsContainer.innerHTML = '<p>Loading current model info...</p>';

            try {
                const [statsRes, redisInfoRes] = await Promise.all([
                    fetch('/stats'),
                    fetch('/redis-info')
                ]);

                if (!statsRes.ok || !redisInfoRes.ok) {
                    throw new Error('Failed to fetch model information.');
                }

                const stats = await statsRes.json();
                const redisInfo = await redisInfoRes.json();

                const accuracy_text = stats.accuracy ? `${(stats.accuracy * 100).toFixed(2)}%` : 'Not available';
                const vector_count = redisInfo.num_vectors !== undefined ? redisInfo.num_vectors : 'Not available';
                
                statsContainer.innerHTML = `
                    <p><strong>Current Model Accuracy (from last training):</strong> ${accuracy_text}</p>
                    <p><strong>Trained Examples (Vectors in DB):</strong> ${vector_count}</p>
                    <hr>
                    <p>Clicking 'Start New Training' will delete all existing trained data and rebuild the model using the <code>spam_dataset.json</code> file.</p>
                `;
            } catch (error) {
                statsContainer.innerHTML = `<p style="color: red;">Could not load model info: ${error.message}</p>`;
            }
        }

        async function executeTraining() {
            const trainButton = document.getElementById('start-training-btn');
            const logContainer = document.getElementById('log-container');
            
            trainButton.disabled = true;
            trainButton.textContent = 'üë®‚Äçüè´ Training in progress...';
            logContainer.textContent = 'Requesting to start training...';
            
            // Start polling for logs
            const logInterval = setInterval(refreshLogs, 2000);

            try {
                const response = await fetch('/train', { method: 'POST' });
                const result = await response.json();
                logContainer.textContent += `\nServer response: ${result.message}`;
            } catch (error) {
                logContainer.textContent += `\n\nError starting training: ${error.message}`;
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å –ª–æ–≥–æ–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ä—Ç–∞
                clearInterval(logInterval);
                trainButton.disabled = false;
                trainButton.textContent = 'üöÄ Start New Training';
            }
            // –¢–µ–ø–µ—Ä—å –º—ã –Ω–µ –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert.
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤–∏–¥–∏—Ç –ø–æ –ª–æ–≥–∞–º, –∫–æ–≥–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —É–º–Ω—É—é –ª–æ–≥–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø–∞—Ä—Å–∏—Ç—å –ª–æ–≥–∏ 
            // –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ.
        }

        async function refreshLogs() {
            const logContainer = document.getElementById('log-container');
            try {
                const response = await fetch('/get-logs');
                if (response.ok) {
                    const logs = await response.text();
                    if (logs.trim() !== logContainer.textContent.trim()) {
                        logContainer.textContent = logs;
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
            } catch (error) {
                console.error("Failed to fetch logs:", error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            switchView('moderation');
            loadAndClassifyPosts(currentPage);
            showRedisInfo();
            document.getElementById('manual-title').value = "How to earn $1000 in a week!";
            document.getElementById('manual-description').value = "Click this link now for a limited time offer. You won't regret it. Best crypto strategy.";
            document.getElementById('manual-tags').value = "money, crypto, investment, quick";
            document.getElementById('manual-reactions').value = "1";
            document.getElementById('manual-comments').value = "0";
            document.getElementById('manual-reading-time').value = "1";
            document.getElementById('manual-followers').value = "5";
        });
    </script>
</body>
</html>